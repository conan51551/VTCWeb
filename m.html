<!DOCTYPE HTML>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=9, IE=8, chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="screen-orientation" content="portrait">
    <meta name="x5-orientation" content="portrait">
    <meta name="full-screen" content="yes">
    <meta name="x5-fullscreen" content="true">
    <meta name="browsermode" content="application">
    <meta name="x5-page-mode" content="app">
    <meta name="msapplication-tap-highlight" content="no">
    <title>VTC云直播</title>
    <link rel="stylesheet" href="vue/m.css">
    <link href="favicon.ico" rel="icon" type="image/x-icon" />
    <!--CDN 取Vue得文件-->
    <script src="//cdn.bootcss.com/vue/2.3.3/vue.min.js"></script>
    <!--CDN失败走本地-->
    <script type="text/javascript">
        window.Vue || document.write('<script src="vue/vue.min.js" type="text/javascript">\x3C/script>')
    </script>
    <!--CDN 取jquery得文件-->
    <script src="//cdn.bootcss.com/jquery/2.1.3/jquery.min.js"></script>
    <script type="text/javascript" src="js/artEditor.js"></script>
    <!--CDN失败走本地-->
    <script type="text/javascript">
        window.jQuery || document.write('<script src="js/jquery-2.1.3.min.js?version=1" type="text/javascript">\x3C/script>')
    </script>
    <script src="/LiveVideoServer/js/netim.vtc.js" type="text/javascript"></script>
</head>
<style>
    .videopalyer {
        border: 1px solid #FFB101;
    }
</style>

<body>
    <div id="player" class="display-flex">
        <!--视频模块-->
        <div class="video-box display-flex">
            <div :style="{height:videoBox+'px'}">
                <!--:style="'background-image:url('+videoInfo.videoPoster+')'"-->
                <video :src="videoInfo.videoUrl" :poster="videoInfo.videoPoster" autoplay x5-video-player-type="h5" x5-video-player-fullscreen="true" x5-video-orientation="portrait|landscape" height="100%" webkit-playsinline="true" x5nativepanel="" width="100%" preload="none" playsinline="true"
                    @timeupdate="timeupdate" x-webkit-airplay="allow" @loadstart="loadstart" @canplay="canplay" @play="controlsChange" @pause="controlsChange">{{errorMsg}}</video>
                <!--视频控制条-->
                <video-controls ref="controls" :liveFlag="videoInfo.liveFlag"></video-controls>
            </div>
            <!--多路直播-->
            <div id='slide_liveVideo' v-show="videos.length>0">
                <template v-for="(item,index) in videos">
                    <div :class="['blockinline', 'liveVideo',{ videopalyer :item.videoId == videoInfo.videoId}]" @click="palyVideo(item.videoId)">
                        <img class='video_preview' :src="item.previewPic">
                        <img class='playBtn' src='img/vtc-m/playBtn.png' @click='playVideo(item.videoId)'>
                        <span style='color:#FFB101;'>直播{{index+1}}</span>
                    </div>
                </template>
            </div>
        </div>

        <!--扩展模块-->
        <modubar ref="bar"></modubar>
        <div id="extendModel" class="extend-model display-flex">
            <!--<p v-show="loadModels" class="model-msg">模块加载中...</p>-->
        </div>
    </div>
</body>

<!--视频控制条-->
<script src="vue/videoControl/control.js" type="text/javascript"></script>
<link rel="stylesheet" href="vue/videoControl/control.css">

<!--touchBar-->
<script src="vue/modulBar/modulBar.js" type="text/javascript"></script>
<link rel="stylesheet" href="vue/modulBar/modulBar.css">
<script>
    //全局模块配置文件
    var modelJson = [{
        id: 1,
        name: "互动",
        ref: "hudong",
        jsPath: 'vue/hudong/interect.js',
        cssPath: 'vue/hudong/interect.css'
    }, {
        id: 2,
        name: "图文",
        ref: "pat",
        jsPath: 'vue/picAndText/picAndText.js',
        cssPath: 'vue/picAndText/picAndText.css'
    }];

    /*
     *返回模块的ref
     *param : modelId 模块ID
     *return : ref
     */
    function queryModelRef(modelId) {
        //筛选出对应ID的模块
        var model = modelJson.filter(function(item) {
            return item.id == modelId;
        })[0]
        return model.ref;
    }

    //模块加载对象
    var loadModels = {
        loadNum: 0, //加载的模块数量
        finish: 0, //一级加载完成的模块
        initModel: initModel, //模块加载完成后初始化vue对象
        timeOut: 5000, //模块加载超时时间
        freshTime: 100, //定时检查间隔
    }

    //所有模块统一的Vue对象
    var models;
    //模块加载完成后初始化vue对象
    function initModel(_index) {
        var times = 0; //刷新次数
        var initTime = setInterval(function() {
            //模块全部加载完成或者超时
            if (loadModels.loadNum == loadModels.finish || times >= (loadModels.timeOut / loadModels.freshTime)) {
                clearInterval(initTime)
                models = new Vue({
                    el: '#extendModel',
                    data: {
                        selectModel: 1 //初始化旋转模块是1
                    }
                })
                console.log("模块初始化完成...")
            }
            times++;
        }, loadModels.freshTime)
    }

    //用户信息
    var userInfo = {
        userId: 0, //用户ID
        isAdminUser: getCookie("adminGroup") == GetQueryString("gid"), //是不是管理员
        nickname: "游客" + randomString(6, false), //用户名
        wxNick: unescape(decodeURI(decodeURI(getCookie("wxNick")))) //微信名
    }

    //场次信息
    var recordInfo = {}

    //当前视频的信息
    var videoInfo = {
        videoPoster: '', //视频的缩略图
        videoUrl: '', //视频播放链接
        videoId: GetQueryString("videoId"), //视频ID
        liveWay: GetQueryString("liveWay"), // 视频类型 0:历史视频 1：导播 2：并行
        liveFlag: 1, // 是否正在直播 0:历史 1:直播
        rid: GetQueryString("rid"), //场次ID
        groupId: GetQueryString("gid"), //组ID
    };
    //多路直播视频信息
    var videos = [];

    var hostname = location.hostname;
    //获取用户昵称
    var randomStr = randomString(6, true);
    //是管理员的情况下
    if (userInfo.isAdminUser) {
        if (getCookie("mypass@" + hostname) != "" &&
            getCookie("mypass@" + hostname) != null) {
            userInfo.userId = getCookie("userId2");
            userInfo.nickname = unescape(decodeURI(decodeURI(getCookie("username2"))));
        } else {
            clearCookie("LiveGroupAdmin2");
            clearCookie("userId2");
            clearCookie("username2");
            clearCookie("isAdmin2");
            userInfo.isAdminUser = false;
        }
    }

    //主Vue对象
    var player = new Vue({
        el: "#player",
        data: {
            videoBox: 0, //视频盒子高度
            videoInfo: videoInfo, //视频信息
            errorMsg: '', //错误信息
            videos: videos, //多路视频信息
            loadModels: true, //模块加载状态
        },
        mounted: function() {
            var that = this;
            getRidInfo(); //获取场次信息
            //TODO del 
            getVideoInfo()
                //计算视频高度
            var ww = $(window).width();
            that.videoBox = ww * (9 / 16);
        },
        methods: {
            //视频播放控制
            controlsChange() {
                this.$refs.controls && this.$refs.controls.controlsChange();
            },
            //视频时间更新
            timeupdate() {
                this.$refs.controls && this.$refs.controls.timeupdate();
            },
            loadstart() {
                this.$refs.controls && this.$refs.controls.loadstart();
            },
            canplay() {
                this.$refs.controls && this.$refs.controls.canplay();
            },
            //获取视频的播放地址
            queryVideoPoster() {
                $.ajax({
                    type: "POST",
                    url: "ajx/VideoPostPic.do",
                    data: "option=query&rid=" + GetQueryString("rid"),
                    success: function(res) {
                        if (res.code == 0) {
                            video.poster = res.data;
                        } else if (liveFlag == 0) {} else {}
                    },
                });
            },
            //获取导播视频信息
            queryVideoUrl: function() {
                getVideoInfo();
            },
            //多路播放某一条视频
            palyVideo(videoID) {
                alert('播放' + videoID)
            }

        }
    })

    //1 获取场次相关信息
    //设置功能模块订制
    function getRidInfo() {
        var url;
        var preData;
        var isPreview = GetQueryString("isPreview");
        if (isPreview == "preview") {
            url = "ajx/ssdb_vtcHget.do";
            preData = "key=LIVEGROUP:RECORD:" + rid;
        } else {
            url = queryFilePath() + videoInfo.groupId + "/record_" + videoInfo.rid + ".json";
        }
        $.ajax({
            url: url,
            type: "get",
            data: preData,
            dataType: "json",
            success: function(res) {
                recordInfo = res;
                player.$refs.bar.getRecordTabsInfo();
                var m = 0;
                var tabs;
                var tabsName;
                if (isPreview == "preview") {
                    tabs = res.tabs;
                    tabsName = res.tabsName;
                } else {
                    tabs = res.tabs;
                    tabsName = res.tabsName;
                }
                if (tabs != null && tabs != "" && tabs && tabs.length != 9) { //当没有第六位数字时，按照以前的设置来
                    var adMsgTab = tabs.substr(tabs.length - 3, 1);
                    tabs = tabs.substring(0, tabs.length - 4);
                    if (adMsgTab != 0) {
                        // queryAdMsg(); //根据模块的信息，判断是否显示轮播广告
                        console.log("轮播")
                    }
                }

                if (videoInfo.groupId == 731) {
                    tabs = "1,0,3,0,0";
                }
                if (tabs == null || tabs == "" || tabs == "null") {
                    for (var i = 0; i < 5; i++) {
                        var tabsIndex = "tab" + (i + 1).toString();
                        $("#" + tabsIndex).show();
                    }
                } else {
                    var modulationArr = tabs.split(",");
                    console.log("modulationArr=" + modulationArr)
                    var tabsNameArr = [];
                    if (tabsName != null && tabsName != "" && tabsName != "null") {
                        tabsNameArr = tabsName.split(",");
                    }
                    for (var i = 0; i < tabsNameArr.length; i++) {
                        var tabsIndex = "tab" + (i + 1).toString();
                        $("#" + tabsIndex).html(tabsNameArr[i]);
                    }

                    for (var i = 0; i < modulationArr.length; i++) {
                        if (modulationArr[i] != "0") {
                            var tabsIndex = "tab" + (i + 1).toString();
                            $("#" + tabsIndex).show();
                            m = m + 1;
                        }
                    }
                    var modulationArr1 = modulationArr.filter(function(item, index) {
                        return item != 0;
                    })
                    if (!modulationArr1.length) {
                        var videBox = $(window).width();
                        $('.bottom-box').css('margin-top', $(".fix-top").height() || 0);
                    }
                    for (var i = 0; i < modulationArr.length; i++) {
                        if (modulationArr[i] != "0") {
                            break;
                        }
                    }
                }

                //设置直播类型
                videoInfo.liveWay = res.liveWay;
                if (videoInfo.liveWay == 1) {
                    console.log("导播视频")
                    getVideoInfo();
                } else if (videoInfo.liveWay == 2) {
                    console.log("并行视频")
                    getLiveVideo4Parell();
                }
            }
        })
    }
    //2.1 导播->视频获取视频相关信息
    function getVideoInfo() {
        $.ajax({
            "url": queryFilePath() + "/videos/" + videoInfo.videoId + ".json",
            "type": "GET",
            "dataType": "json",
            "async": false,
            "success": function(data) {
                var video = data;
                if (video != null) {
                    //判断是不是正在直播
                    if (video.liveFlag == 1) {
                        var urlStr = video.URL;
                        if (urlStr.indexOf('live.m3u8') == -1) {
                            var url4live = urlStr.substring(0, urlStr.lastIndexOf("/")) + "live.m3u8";
                        } else {
                            var url4live = urlStr;
                        }
                    } else {
                        var url4live = video.URL;
                    }

                    var vDomain = quertVDomain();
                    if (url4live.toLowerCase().indexOf("http") != 0) {
                        if (url4live.indexOf("/") == 0) {
                            url4live = "http://" + vDomain + "/" + url4live;
                        } else {
                            url4live = "http://" + vDomain + "/LiveVideoServer/" + url4live;
                        }
                    }
                    videoInfo.videoUrl = url4live + "?randomStr=" + parseInt((new Date()).getTime() / 300000);
                    videoInfo.videoPoster = "http://" + location.hostname + "/" + video.previewPic;
                    if (!navigator.userAgent.match(/(iPad|iPhone|iPod)/g)) {
                        if (isWeixin()) {
                            videoInfo.videoPoster = '';
                            $("video").css("background-image", "url(http://" + location.hostname + "/" + video.previewPic + ")")
                        }
                    }
                }

                var title = video.title;
                var titSpan = document.createElement('span');
                titSpan.innerHTML = title;

                if (title == '无标题' || title == '') {
                    title = "VTC云直播";
                } else {
                    title = titSpan.innerText;
                }
                document.title = titSpan.innerText + ' by VTC云直播';
                parent.document.title = titSpan.innerHTML + ' by VTC云直播';
            },
            "error": function(res) {
                if (res.status == "404") {
                    // player.errorMsg = '该视频文件不存在';
                }
            }
        });
    }

    function isWeixin() {
        var ua = navigator.userAgent.toLowerCase();
        if (ua.match(/MicroMessenger/i) == "micromessenger") {
            return true;
        } else {
            return false;
        }
    }

    //2.2 并行直播->判断其视频直播状态以及哪些视频正在直播 (轮询)
    function getLiveVideo4Parell() {
        if (hostname == "voip.vtc365.com") {
            var url = "http://" + hostname + "/LiveVideoServer/streams/s2/videos.json";
        } else if (hostname == "www.vtc365.cn") {
            var url = "http://" + hostname + "/LiveVideoServer/streams/videos.json";
        } else if (hostname == 'multi3.in.vtc365.com') {
            var url = "http://" + hostname + "/LiveVideoServer/streams/s3/videos.json";
        } else if (hostname == 't.vtc365.com') {
            var url = "http://" + hostname + "/LiveVideoServer/streams/s10/videos.json";
        }
        $.ajax({
            "url": url,
            "type": "get",
            "dataType": "json",
            "success": function(data) {
                var json = data;
                videoInfo.liveFlag = 0;
                var videoStr;
                for (var x in json) {
                    var key = x;
                    if (x == videoInfo.groupId) {
                        videoInfo.liveFlag = 1;
                        videoStr = json[x];
                    }
                }
                if (videoInfo.liveFlag == 1) { //正在直播
                    var _videos = [];
                    for (key in videoStr) {
                        //TODO 优化添加流程
                        _videos.push({
                            videoId: key,
                            previewPic: videoStr[key].previewPic
                        });
                    }
                    videos = _videos;
                    // if (videos.length > 1 && needPosition) {
                    //     for (var i = 0; i < videos.length; i++) {
                    //         var vid = videos[i].videoId;
                    //         if (videoId == vid) {
                    //             if (i >= video_length && startNum == 0) {
                    //                 var pageNum = Math.floor(i / video_length);
                    //                 startNum = video_length * pageNum;
                    //             }
                    //         }
                    //     }
                    // }
                    // var length = startNum + video_length;
                    // if (length > videos.length) {
                    //     length = videos.length;
                    // }
                }
            }
        });
        timer = window.setTimeout(function() {
            getLiveVideo4Parell();
        }, 5000);
    }


    // 同城播放器事件
    window.onresize = function() {
        var video = document.querySelector("video");
        video.style.width = window.innerWidth + "px";
        video.style.height = window.innerHeight + "px";
        // if(!video.paused){
        //     var wh = $(window).height();
        //     var sl = videos.length > 0 ? 55 : 0;
        //     elHight.extendModel = wh - elHight.videoBox - sl;
        //     $("#vtcInterectMod").height(elHight.extendModel - 30);
        //     if(models.interect){
        //         models.interect.calcHDHeight();
        //     }
        // }
    }

    //搞笑的旋转事件 先这么用着
    $(window).bind('orientationchange', function(e) {
        if (window.orientation == 180 || window.orientation == 0) {
            $("#extendModel").show();
            $('body').removeClass("landscape")
            $('#player').removeClass("landscape")
            $('.video-box').removeClass("landscape")
            $('video').removeClass("landscape")
            $('.video-box>div').removeClass("landscape")
            $('#videoControls').removeClass("landscape")
        } else if (window.orientation == 90 || window.orientation == -90) {
            $("#extendModel").hide();
            $('body').addClass("landscape")
            $('#player').addClass("landscape")
            $('.video-box').addClass("landscape")
            $('video').addClass("landscape")
            $('.video-box>div').addClass("landscape")
            $('#videoControls').addClass("landscape")
        }
    });

    //获取视频播放的host地址
    function quertVDomain() {
        var vDomain = hostname;
        switch (hostname) {
            case 'voip.vtc365.com':
                vDomain = "v.vtc365.com";
                break;
            case 'www.vtc365.cn':
                vDomain = "www.vtc365.cn";
                break;
            case 't.vtc365.com':
                vDomain = "v.vtc365.com";
                break;
        }
        return vDomain;
    }

    //获取分界点存放路径 返回到streams下一级
    function queryFilePath() {
        var hostname = location.hostname;
        var path = "";
        switch (hostname) {
            case 'voip.vtc365.com':
                path = "http://voip.vtc365.com/LiveVideoServer/streams/s2/";
                break;
            case 'www.vtc365.cn':
                path = "http://www.vtc365.cn/LiveVideoServer/streams/";
                break;
            case 'multi3.in.vtc365.com':
                path = "http://multi3.in.vtc365.com/LiveVideoServer/streams/s3/";
                break;
            case 't.vtc365.com':
                path = "http://t.vtc365.com/LiveVideoServer/streams/s10/";
                break;
        }
        //后续调用直接返回路径不在判断
        queryFilePath = function() {
            return path;
        }
        return path;
    }

    //生成随机数
    function randomString(len) {
        len = len || 32;
        var $chars = 'ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678';
        /****默认去掉了容易混淆的字符oOLl,9gq,Vv,Uu,I1****/
        var maxPos = $chars.length;
        var pwd = '';
        for (i = 0; i < len; i++) {
            pwd += $chars.charAt(Math.floor(Math.random() * maxPos));
        }
        return pwd;
    }

    function GetQueryString(name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
        var r = window.location.search.substr(1).match(reg);
        if (r != null)
            return unescape(r[2]);
        return null;
    }

    function setCookie(c_name, value, expiredays) {
        var exdate = new Date()
        exdate.setDate(exdate.getDate() + expiredays)
        document.cookie = c_name + "=" + escape(value) +
            ((expiredays == null) ? "" : ";expires=" + exdate.toGMTString())
    }
    //获取cookie
    function getCookie(cname) {
        var arr = document.cookie.match(new RegExp("(^| )" + cname + "=([^;]*)(;|$)"));
        if (arr != null) return unescape(arr[2]);
        return null;
    }
    //清除cookie
    function clearCookie(name) {
        setCookie(name, "", -1);
    }
    // 动态加载js 
    function loadScript(path) {
        var script = document.createElement("script");
        script.type = "text/javascript";
        script.src = path;
        script.async = false;
        document.body.appendChild(script);
        if (script.readyState == "loaded" || script.readyState == "complete") {
            script.onreadystatechange = null;
        }
    }
    // 动态加载css
    function loadStyles(path) {
        var link = document.createElement("link");
        link.type = "text/css";
        link.rel = "stylesheet";
        link.href = path;
        document.getElementsByTagName("head")[0].appendChild(link);
    }

    $('#player').on('touchmove touchstart', function(event) {
        event.stopPropagation();
    });
</script>
<script>
    // var isc = true;
    // setInterval(function(){
    //     interect.nickname = isc ? '我是范俊声' : "我是黄友伟!!";
    //     interect.sendMsg = isc ? '你瞅啥!' : "瞅你咋地!!";
    //     isc = !isc ;
    //     interect.submitClick();
    // },1000)
</script>

</html>